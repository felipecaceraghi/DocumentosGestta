{% extends "base.html" %}

{% block content %}
<style>
.phrase-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 10px 16px;
  margin-bottom: 8px;
  min-width: 220px;
  max-width: 100%;
  min-height: 48px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  transition: box-shadow 0.2s, border 0.2s;
}
.phrase-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.10);
  border-color: #0d6efd;
}
.phrase-card span {
  flex: 1;
  font-size: 1rem;
  color: #343a40;
  word-break: break-word;
}
.delete-btn {
  background: none;
  border: none;
  color: #dc3545;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
  padding: 0 8px;
  border-radius: 50%;
  transition: background 0.2s, color 0.2s;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}
.delete-btn:hover {
  background: #ffe5e9;
  color: #fff;
  box-shadow: 0 2px 8px rgba(220,53,69,0.15);
}
.delete-btn svg {
  width: 20px;
  height: 20px;
  display: block;
}
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='phrase-card.css') }}">
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- process controls moved into a tab below -->

        <div class="card">
            <div class="card-header bg-info text-white text-center">
                <h3><i class="fas fa-cogs"></i> Sistema de Cobrança de Documentos Gestta</h3>
                {% if config.settings.debug_mode %}
                <div class="mt-2">
                    <small class="badge bg-secondary">Debug: {{ companies|length }} empresas | {{ users|length }} usuários carregados</small>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies" type="button" role="tab">
                            <i class="fas fa-building"></i> Empresas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users"></i> Usuários
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="process-tab" data-bs-toggle="tab" data-bs-target="#process" type="button" role="tab">
                            <i class="fas fa-play-circle"></i> Processar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="task-management-tab" data-bs-toggle="tab" data-bs-target="#task-management" type="button" role="tab">
                            <i class="fas fa-tasks"></i> Gerenciar Tarefas
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="configTabsContent">
                    <div class="tab-pane fade show active" id="companies" role="tabpanel">
                        <h5>Selecionar Empresas</h5>
                        <div class="mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Pesquisar empresas..." id="searchCompaniesInput">
                            </div>
                        </div>
                        <form id="selectionForm" method="POST" action="{{ url_for('save_selection') }}">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary mb-3" onclick="selectAll('companies')">Selecionar Todas</button>
                                    <button type="button" class="btn btn-outline-secondary mb-3 ms-2" onclick="clearAll('companies')">Limpar Seleção</button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col">Selecionar</th>
                                            <th scope="col">Código</th>
                                            <th scope="col">Nome</th>
                                        </tr>
                                    </thead>
                                    <tbody id="companiesTableBody">
                                        <!-- Companies will be rendered here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                    </div>
                    <div class="tab-pane fade" id="process" role="tabpanel">
                        <h5>Processar</h5>
                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-auto">
                                <label class="form-label mb-0 small">Data Início</label>
                                <input type="text" id="startDateInput" class="form-control form-control-sm" placeholder="Selecione a data..."/>
                            </div>
                            <div class="col-auto">
                                <label class="form-label mb-0 small">Data Fim</label>
                                <input type="text" id="endDateInput" class="form-control form-control-sm" placeholder="Selecione a data..."/>
                            </div>
                            <div class="col-auto">
                                <button type="button" id="startProcessingBtn" class="btn btn-warning btn-lg">Processar Tarefas</button>
                            </div>
                            <div class="col">
                                <div id="processingStatus" class="text-end">&nbsp;</div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <h5>Selecionar Usuários</h5>
                        <div class="mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Pesquisar usuários..." id="searchUsersInput">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary mb-3" onclick="selectAll('users')">Selecionar Todos</button>
                                <button type="button" class="btn btn-outline-secondary mb-3 ms-2" onclick="clearAll('users')">Limpar Seleção</button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Selecionar</th>
                                        <th scope="col">Nome</th>
                                        <th scope="col">Email</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be rendered here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% include 'task_management.html' %}
                </div>
                <div class="mt-3 d-flex justify-content-end">
                    <!-- Save selection button: submit the selectionForm -->
                    <button type="submit" form="selectionForm" class="btn btn-success" id="saveSelectionBtn">
                        <i class="fas fa-save"></i> Salvar Seleção
                    </button>
                </div>
                </form>
            </div>
        </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from server (Jinja -> JSON)
    const originalCompanies = {{ companies | default([]) | tojson | safe }};
    const originalUsers = {{ users | default([]) | tojson | safe }};
        // Initialize date pickers
        flatpickr("#startDateInput", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            locale: "pt"
        });
        flatpickr("#endDateInput", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            locale: "pt"
        });

        // Start processing and poll status (UI updates)
        document.getElementById('startProcessingBtn').addEventListener('click', async function () {
            const btn = this;
            const statusEl = document.getElementById('processingStatus');
            try {
                btn.disabled = true;
                statusEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <strong>Executando...</strong>';
                // Trigger run route (GET) with optional date params
                const sVal = document.getElementById('startDateInput') ? document.getElementById('startDateInput').value : '';
                const eVal = document.getElementById('endDateInput') ? document.getElementById('endDateInput').value : '';
                let runUrl = '{{ url_for("run") }}';
                const params = new URLSearchParams();
                if (sVal) params.set('start_date', sVal);
                if (eVal) params.set('end_date', eVal);
                if (params.toString()) runUrl += '?' + params.toString();
                // Trigger run route (GET)
                const resp = await fetch(runUrl);
                if (!resp.ok && resp.status !== 200) {
                    statusEl.textContent = 'Erro ao iniciar processamento';
                    btn.disabled = false;
                    return;
                }
                // Poll status
                const statusPoll = setInterval(async () => {
                    try {
                        const s = await (await fetch('{{ url_for("processing_status") }}')).json();
                        // update status message
                        if (s.running) {
                            statusEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <strong>Executando...</strong>';
                        } else {
                                clearInterval(statusPoll);
                                btn.disabled = false;
                                // show summary card if provided
                                if (s.summary) {
                                    try {
                                        const summary = s.summary;
                                        const modalBody = document.getElementById('processingSummaryModalBody');
                                        modalBody.innerHTML = `
                                            <div class="container-fluid">
                                                <div class="row mb-2">
                                                    <div class="col-md-6"><strong>Tempo total:</strong> ${formatTime(summary.tempo_total)}</div>
                                                    <div class="col-md-6"><strong>Documentos baixados:</strong> ${summary.documentos_baixados || 0}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-md-4"><strong>Alertas enviados:</strong> ${summary.alertas_enviados || 0}</div>
                                                    <div class="col-md-4"><strong>Tarefas com sucesso:</strong> ${summary.tarefas_processadas_com_sucesso || 0}</div>
                                                    <div class="col-md-4"><strong>Empresas processadas:</strong> ${summary.empresas_processadas || 0}</div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12"><small class="text-muted">Gerado em: ${summary.data_hora || ''}</small></div>
                                                </div>
                                            </div>`;
                                        const modalEl = document.getElementById('processingSummaryModal');
                                        const modal = new bootstrap.Modal(modalEl);
                                        modal.show();
                                    } catch (err) {
                                        console.warn('Erro ao renderizar summary modal:', err);
                                    }
                                }

                                if (s.success) {
                                    statusEl.innerHTML = '<span class="text-success">Processamento finalizado com sucesso.</span>';
                                    try {
                                        const toastEl = document.getElementById('processToast');
                                        const toastBody = document.getElementById('processToastBody');
                                        toastBody.textContent = 'Processamento finalizado com sucesso.';
                                        const toast = new bootstrap.Toast(toastEl);
                                        toast.show();
                                    } catch (e) { console.warn(e); }
                                } else {
                                    statusEl.innerHTML = '<span class="text-danger">Processamento finalizado, ver logs.</span>';
                                    try {
                                        const toastEl = document.getElementById('processToast');
                                        const toastBody = document.getElementById('processToastBody');
                                        toastBody.textContent = 'Processamento finalizado com erros. Ver logs.';
                                        const toast = new bootstrap.Toast(toastEl);
                                        toast.show();
                                    } catch (e) { console.warn(e); }
                                }
                        }
                    } catch (err) {
                        console.error('Erro ao checar status:', err);
                        statusEl.textContent = 'Erro ao checar status';
                        clearInterval(statusPoll);
                        btn.disabled = false;
                    }
                }, 2000);
            } catch (err) {
                statusEl.textContent = 'Erro ao iniciar processamento: ' + err.message;
                btn.disabled = false;
            }
        });
    // Use Sets for fast membership checks and updates
    let selectedCompanies = new Set({{ selected_companies | default([]) | tojson | safe }});
    let selectedUsers = new Set({{ selected_users | default([]) | tojson | safe }});

    // Small debounce util to avoid excessive renders while typing
    function debounce(fn, wait = 200) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // Helpers to get current filtered lists
    function getFilteredCompanies() {
        const q = document.getElementById('searchCompaniesInput').value.trim().toLowerCase();
        if (!q) return originalCompanies;
        return originalCompanies.filter(c => (c.name || '').toLowerCase().includes(q) || (c.code || '').toLowerCase().includes(q));
    }

    function getFilteredUsers() {
        const q = document.getElementById('searchUsersInput').value.trim().toLowerCase();
        if (!q) return originalUsers;
        return originalUsers.filter(u => (u.name || '').toLowerCase().includes(q) || (u.email || '').toLowerCase().includes(q));
    }

    // Efficient render: build rows as a single HTML string and set once
    function renderCompaniesTable(filteredCompanies) {
        const tbody = document.getElementById('companiesTableBody');
        
        if (!filteredCompanies || filteredCompanies.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Nenhuma empresa encontrada. Verifique a conexão com a API.
                    </td>
                </tr>`;
            return;
        }
        
        const rows = filteredCompanies.map(company => {
            const id = company._id;
            const checked = selectedCompanies.has(id) ? 'checked' : '';
            // escape values when inserting into HTML if necessary (we assume tojson provided safe values)
            return `
                <tr>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="companies" value="${id}" id="company_${id}" ${checked}>
                            <label class="form-check-label" for="company_${id}"></label>
                        </div>
                    </td>
                    <td>${company.code || ''}</td>
                    <td>${company.name || ''}</td>
                </tr>`;
        }).join('');
        tbody.innerHTML = rows;
    }

    function renderUsersTable(filteredUsers) {
        const tbody = document.getElementById('usersTableBody');
        
        if (!filteredUsers || filteredUsers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Nenhum usuário encontrado. Verifique a conexão com a API.
                    </td>
                </tr>`;
            return;
        }
        
        const rows = filteredUsers.map(user => {
            const id = user._id;
            const checked = selectedUsers.has(id) ? 'checked' : '';
            return `
                <tr>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="users" value="${id}" id="user_${id}" ${checked}>
                            <label class="form-check-label" for="user_${id}"></label>
                        </div>
                    </td>
                    <td>${user.name || ''}</td>
                    <td>${user.email || ''}</td>
                </tr>`;
        }).join('');
        tbody.innerHTML = rows;
    }

    // Debounced input handlers
    const handleCompaniesInput = debounce(() => renderCompaniesTable(getFilteredCompanies()), 180);
    const handleUsersInput = debounce(() => renderUsersTable(getFilteredUsers()), 180);

    document.getElementById('searchCompaniesInput').addEventListener('input', handleCompaniesInput);
    document.getElementById('searchUsersInput').addEventListener('input', handleUsersInput);

    // Selection helpers that update Sets and re-render current filtered lists
    function selectAll(type) {
        if (type === 'companies') {
            selectedCompanies = new Set(originalCompanies.map(c => c._id));
            renderCompaniesTable(getFilteredCompanies());
        } else {
            selectedUsers = new Set(originalUsers.map(u => u._id));
            renderUsersTable(getFilteredUsers());
        }
    }

    function clearAll(type) {
        if (type === 'companies') {
            selectedCompanies.clear();
            renderCompaniesTable(getFilteredCompanies());
        } else {
            selectedUsers.clear();
            renderUsersTable(getFilteredUsers());
        }
    }

    // Initial render
    renderCompaniesTable(originalCompanies);
    renderUsersTable(originalUsers);

    // Event delegation: update Sets when checkboxes change
    document.getElementById('companiesTableBody').addEventListener('change', function (e) {
        const target = e.target;
        if (target && target.name === 'companies') {
            const id = target.value;
            if (target.checked) selectedCompanies.add(id);
            else selectedCompanies.delete(id);
        }
    });

    document.getElementById('usersTableBody').addEventListener('change', function (e) {
        const target = e.target;
        if (target && target.name === 'users') {
            const id = target.value;
            if (target.checked) selectedUsers.add(id);
            else selectedUsers.delete(id);
        }
    });

    // Ensure form submission includes current selections: before submit, sync DOM (checkboxes already reflect Sets via renders)
    // Sync Sets into hidden inputs before submit to guarantee server receives them
    const selectionForm = document.getElementById('selectionForm');
    if (selectionForm) {
        selectionForm.addEventListener('submit', function (e) {
            // remove previous hidden inputs we may have added
            Array.from(selectionForm.querySelectorAll('input[type="hidden"].generated-selection')).forEach(n => n.remove());
            // add companies
            Array.from(selectedCompanies).forEach(id => {
                const inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'companies';
                inp.value = id;
                inp.classList.add('generated-selection');
                selectionForm.appendChild(inp);
            });
            // add users
            Array.from(selectedUsers).forEach(id => {
                const inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'users';
                inp.value = id;
                inp.classList.add('generated-selection');
                selectionForm.appendChild(inp);
            });
            // allow submit to continue
        });
    }

    // Format seconds to readable string
    function formatTime(seconds) {
        if (!seconds && seconds !== 0) return '';
        try {
            seconds = Number(seconds);
            if (isNaN(seconds)) return '';
            if (seconds < 60) return `${seconds.toFixed(2)} seg`;
            return `${(seconds/60).toFixed(2)} min`;
        } catch (e) { return '' }
    }

    // Hide save button when Process tab is active
    (function toggleSaveButtonOnTab() {
        const saveBtn = document.getElementById('saveSelectionBtn');
        const processTabBtn = document.getElementById('process-tab');
        const tabs = document.querySelectorAll('#configTabs button[data-bs-toggle="tab"]');

        function updateVisibility(activeTabId) {
            if (!saveBtn) return;
            if (activeTabId === 'process-tab') {
                saveBtn.style.display = 'none';
            } else {
                saveBtn.style.display = '';
            }
        }

        // initial state
        const active = document.querySelector('#configTabs button.active');
        updateVisibility(active ? active.id : null);

        // listen for tab changes (Bootstrap 5 hides/shows tabs via events)
        tabs.forEach(t => t.addEventListener('shown.bs.tab', function (e) {
            const newId = e.target.id;
            updateVisibility(newId);
        }));
    })();

    // Task Phrases Management
    let taskManagementInitialized = false;
    const taskManagementTab = document.getElementById('task-management-tab');

    taskManagementTab.addEventListener('shown.bs.tab', function () {
        if (taskManagementInitialized) return;
        taskManagementInitialized = true;

        const fiscalPhrasesContainer = document.getElementById('fiscalPhrasesContainer');
        const contabilPhrasesContainer = document.getElementById('contabilPhrasesContainer');
        const newTaskPhraseInput = document.getElementById('newTaskPhraseInput');
        const newTaskPhraseType = document.getElementById('newTaskPhraseType');
        const addTaskPhraseBtn = document.getElementById('addTaskPhraseBtn');
        const saveTaskPhrasesBtn = document.getElementById('saveTaskPhrasesBtn'); // New button
        const taskPhrasesStatus = document.getElementById('taskPhrasesStatus');

        let fiscalPhrases = [];
        let contabilPhrases = [];

        async function loadTaskPhrases() {
            try {
                const response = await fetch('{{ url_for("task_phrases") }}');
                if (!response.ok) throw new Error('Falha ao carregar frases de tarefas');
                const data = await response.json();
                fiscalPhrases = data.fiscal_phrases || [];
                contabilPhrases = data.contabil_phrases || [];
                renderTaskPhrases();
            } catch (error) {
                taskPhrasesStatus.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        function renderTaskPhrases() {
            fiscalPhrasesContainer.innerHTML = fiscalPhrases.map(phrase => createTaskPhraseCard(phrase, 'fiscal')).join('');
            contabilPhrasesContainer.innerHTML = contabilPhrases.map(phrase => createTaskPhraseCard(phrase, 'contabil')).join('');
        }

        function createTaskPhraseCard(phrase, type) {
            return `
                <div class="phrase-card" data-phrase="${phrase}" data-type="${type}">
                    <span>${phrase}</span>
                    <button type="button" class="delete-btn" onclick="deleteTaskPhrase(this)" title="Excluir">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <circle cx="10" cy="10" r="10" fill="#dc3545"/>
                          <path d="M6 6L14 14" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                          <path d="M14 6L6 14" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        window.deleteTaskPhrase = function(btn) {
            const card = btn.closest('.phrase-card');
            const phrase = card.dataset.phrase;
            const type = card.dataset.type;
            if (type === 'fiscal') {
                fiscalPhrases = fiscalPhrases.filter(p => p !== phrase);
            } else {
                contabilPhrases = contabilPhrases.filter(p => p !== phrase);
            }
            renderTaskPhrases();
        }

        addTaskPhraseBtn.addEventListener('click', () => {
            const newPhrase = newTaskPhraseInput.value.trim();
            if (!newPhrase) return;
            const type = newTaskPhraseType.value;
            if (type === 'fiscal') {
                if (!fiscalPhrases.includes(newPhrase)) {
                    fiscalPhrases.push(newPhrase);
                }
            } else {
                if (!contabilPhrases.includes(newPhrase)) {
                    contabilPhrases.push(newPhrase);
                }
            }
            renderTaskPhrases();
            newTaskPhraseInput.value = '';
        });

        saveTaskPhrasesBtn.addEventListener('click', async () => {
            taskPhrasesStatus.innerHTML = '<div class="alert alert-info">Salvando...</div>';
            try {
                const response = await fetch('{{ url_for("task_phrases") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fiscal_phrases: fiscalPhrases,
                        contabil_phrases: contabilPhrases,
                    }),
                });
                if (!response.ok) throw new Error('Failed to save task phrases');
                const result = await response.json();
                taskPhrasesStatus.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
            } catch (error) {
                taskPhrasesStatus.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });

        loadTaskPhrases();
    });

}); // fecha DOMContentLoaded
</script>
{% endblock %}
